<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/static/favicon.png" type="image/png">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∏—Å–∫–æ–≤ | –ü—Ä–æ–§—Ä–∞–Ω—à–∏–∑–∞</title>
    <link rel="stylesheet" href="/static/style_stats.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <header>
        <botton class="title-box">
            <a style="text-decoration: none; color: white;" href="/">–ü—Ä–æ–§—Ä–∞–Ω—à–∏–∑–∞</a>
        </botton>

        <nav>
            <a class="nav-button" href="/">–ì–ª–∞–≤–Ω–∞—è</a>
            <div class="dropdown-container">
                <a class="nav-button" href="/user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</a>
                <div class="dropdown-menu">
                    <a href="/contract">–î–æ–≥–æ–≤–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑</a>
                    <a href="/economic">–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑</a>
                </div>
            </div>
            <a class="nav-button" href="/owner">–ü—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—å</a>
            <a class="nav-button" href="/glossary">–ì–ª–æ—Å—Å–∞—Ä–∏–π</a>
        </nav>
    </header>

    <main>
        <div class="content-section">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∏—Å–∫–æ–≤</h2>

            {% if stats %}
            <div class="dashboard-grid">
                <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: —Ç–∞–±–ª–∏—Ü–∞ –∏ –∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ -->
                <div class="dashboard-row dashboard-row-flex" >
                    <div class="risk-table-container">
                        <table>
                            <thead>
                              <tr>
                                <th>–¢–∏–ø —Ä–∏—Å–∫–∞</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for key, value in stats.by_risk_type.items() %}
                              <tr>
                                <td>{{ risk_translations[key] }}</td>
                                <td>{{ value.count }}</td>
                              </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                    </div>
                    
                    <div class="chart-box fixed-height">
                        <h3>–°–≤–æ–¥–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∏—Å–∫–æ–≤</h3>
                        <div class="chart-container-wrapper">
                            <canvas id="category-bar-chart"></canvas>
                        </div>
                    </div>
                    
                </div>

                <!-- –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞: –¥–∏–∞–≥—Ä–∞–º–º—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
                <div class="dashboard-row dashboard-row-flex">
                    <div class="chart-box fixed-height ">
                        <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                        <div class="chart-container-wrapper">
                            <canvas id="category-pie-chart"></canvas>
                        </div>
                    </div>

                    
                    <div class="chart-box fixed-height" >
                        <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤ –ø–æ —Ç–∏–ø–∞–º</h3>
                        <div class="chart-container-wrapper">
                            <canvas id="risk-pie-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
                <div class="dashboard-row full-width" style="max-width: 100%;">
                    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–æ–≤</h2>

                    {% set risk = namespace(significant=0, high=0, medium=0, low=0) %}

                    {% for key, value in stats.by_risk_type.items() %}
                        {% if key == 'significant' %}
                            {% set risk.significant = value.count %}
                        {% elif key == 'high' %}
                            {% set risk.high = value.count %}
                        {% elif key == 'medium' %}
                            {% set risk.medium = value.count %}
                        {% elif key == 'low' %}
                            {% set risk.low = value.count %}
                        {% endif %}
                    {% endfor %}

                    {% set total_risk = risk.significant + risk.high + risk.medium + risk.low %}

                    <div class="risk-block result-conclusion risk-summary-block">
                        {% if risk.significant > 0 %}
                            <div class="risk-detail no-risk">
                                <div class="critical-message">
                                    –í–Ω–∏–º–∞–Ω–∏–µ! –î–æ–≥–æ–≤–æ—Ä –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–∫–ª—é—á–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è.
                                </div>
                            </div>
                            {% endif %}
                        {% if total_risk == 0 %}
                            <div class="risk-detail no-risk">
                                <h4>‚úÖ –†–∏—Å–∫–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã</h4>
                                <p>–î–æ–≥–æ–≤–æ—Ä —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ù–∞—Ä—É—à–µ–Ω–∏–π –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã—Ö –ø–æ–ª–æ–∂–µ–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ.</p>
                            </div>
                        {% elif risk.high >= 3 or (total_risk > 0 and (risk.high / total_risk) >= 0.4) %}
                            <div class="risk-detail high-risk">
                                <h4>üö® –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–æ–≤</h4>
                                <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –ø—Ä–µ–≤—ã—à–∞–µ—Ç –¥–æ–ø—É—Å—Ç–∏–º—ã–π –ø–æ—Ä–æ–≥. –î–æ–≥–æ–≤–æ—Ä –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è.</p>
                            </div>
                        {% elif risk.medium >= 3 or (total_risk > 0 and (risk.medium / total_risk) >= 0.5) %}
                            <div class="risk-detail medium-risk">
                                <h4>‚ö†Ô∏è –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏</h4>
                                <p>–£—Å–ª–æ–≤–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è, —Ç—Ä–µ–±—É—é—â–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∞–≤–æ–≤–æ–π –∏ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.</p>
                            </div>
                        {% elif risk.low == total_risk %}
                            <div class="risk-detail low-risk">
                                <h4>üü° –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏</h4>
                                <p>–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏ –Ω–µ –ø—Ä–µ–≤—ã—à–∞—é—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞. –î–æ–≥–æ–≤–æ—Ä –º–æ–∂–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è —É—Å–ª–æ–≤–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–º –ø–æ—Å–ª–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–º–µ—á–∞–Ω–∏–π.</p>
                            </div>
                        {% else %}
                            <div class="risk-detail mixed-risk">
                                <h4>üìå –°–º–µ—à–∞–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–æ–≤</h4>
                                <p>–î–æ–≥–æ–≤–æ—Ä —Å–æ–¥–µ—Ä–∂–∏—Ç —É—Å–ª–æ–≤–∏—è —Ä–∞–∑–ª–∏—á–Ω–æ–π —Å—Ç–µ–ø–µ–Ω–∏ —Ä–∏—Å–∫–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–∞–≤–æ–≤–∞—è –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞.</p>
                            </div>
                        {% endif %}
                    </div>


                <!-- –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∏—Å–∫–æ–≤ -->
                <h2>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∏—Å–∫–æ–≤</h2>
                <div class="dashboard-row full-width" style="max-width: 100%;">
                    
                    {% for key, value in stats.by_risk_type.items() %}
                        {% if value.count > 0 %}
                        <div class="risk-block {% if key == 'significant' %}critical-risk{% endif %}" style="max-width: 100%;">
                            {% if key == 'significant' %}
                                <div class="critical-message">
                                    –í–Ω–∏–º–∞–Ω–∏–µ! –î–æ–≥–æ–≤–æ—Ä –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–∫–ª—é—á–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è.
                                </div>
                            {% endif %}
                            <h3>{{ risk_translations[key] }} ({{ value.count }})</h3>
                            
                            {% for detail in value.details %}
                            {% if key == 'significant' %}
                            <div class="risk-detail-critical" style="max-width: 100%;">
                                <p class="question-critical" style="max-width: 100%;">–í–æ–ø—Ä–æ—Å: {{ detail.question }}</p>
                                <p class="answer-critical" style="max-width: 100%;">–û—Ç–≤–µ—Ç: {{ detail.answer }}</p>
                                {% if detail.recomendations %}
                                <div class="recommendation-critical" style="max-width: 100%;">
                                    <p>
                                        {% for rec in detail.recomendations %}
                                            {{ rec }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </p>
                                    {% if detail.article and detail.article[0] != 'None' and detail.link %}
                                        <a href="{{ detail.link|replace('[', '',)|replace(']', '')|replace("'", "") }}" target="_blank" rel="noopener noreferrer">
                                            {{ detail.article[0] }}
                                        </a>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>    
                            {% else %}
                            <div class="risk-detail" style="max-width: 100%;">
                                <p class="question" style="max-width: 100%;">–í–æ–ø—Ä–æ—Å: {{ detail.question }}</p>
                                <p class="answer" style="max-width: 100%;">–û—Ç–≤–µ—Ç: {{ detail.answer }}</p>
                                {% if detail.recomendations %}
                                <div class="recommendation" style="max-width: 100%;">
                                    <p>
                                        {% for rec in detail.recomendations %}
                                            {{ rec }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </p>
                                    {% if detail.article and detail.article[0] != 'None' and detail.link %}
                                        <a href="{{ detail.link|replace('[', '',)|replace(']', '')|replace("'", "") }}" target="_blank" rel="noopener noreferrer">
                                            {{ detail.article[0] }}
                                        </a>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            
            <div class="download-section">
                <a href="/download/?session_id={{ session_id }}" download>
                    <button class="download-button">–°–ö–ê–ß–ê–¢–¨ –û–¢–ß–Å–¢</button>
                </a>
            </div>
            
            {% elif session_id %}
            <div class="no-data-box">
                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è session_id: <b>{{ session_id }}</b></p>
            </div>
            {% else %}
            <div class="no-data-box">
                <p>Session ID –Ω–µ –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω.</p>
            </div>
            {% endif %}
        </div>
    </main>

    <footer class="footer">
        <div class="footer-box">
            ¬© (www.pf.claba.ru) | –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã, 2025
        </div>
    </footer>

    <script>
        // –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        const riskStats = {
            "significant": {{ stats.by_risk_type['significant'].count }},
            "high": {{ stats.by_risk_type['high'].count }},
            "medium": {{ stats.by_risk_type['medium'].count }},
            "low": {{ stats.by_risk_type['low'].count }}
        };

        const ctxRisk = document.getElementById('risk-pie-chart').getContext('2d');
        const riskPieChart = new Chart(ctxRisk, {
            type: 'pie',
            data: {
                labels: ['–°—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∏—Å–∫', '–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫', '–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫', '–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∏—Å–∫'],
                datasets: [{
                    data: [riskStats.significant, riskStats.high, riskStats.medium, riskStats.low],
                    backgroundColor: ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71'],
                    borderColor: ['#c0392b', '#d35400', '#f39c12', '#27ae60'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        const categoryLabels = {{ stats.by_category.keys()|list|tojson }};
        const categoryData = {{ stats.by_category.values()|map(attribute='total')|list|tojson }};

        const ctxCategory = document.getElementById('category-pie-chart').getContext('2d');
        const categoryPieChart = new Chart(ctxCategory, {
            type: 'pie',
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryData,
                    backgroundColor: [
                        '#9b59b6',  // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π  
                        '#3498db',  // —Å–∏–Ω–∏–π  
                        '#1abc9c',  // –±–∏—Ä—é–∑–æ–≤—ã–π  
                        '#34495e',  // —Ç–µ–º–Ω–æ-—Å–µ—Ä–æ-—Å–∏–Ω–∏–π  
                        '#e84393',  // —Ä–æ–∑–æ–≤—ã–π  
                        '#00b894',  // –º—è—Ç–Ω—ã–π  
                        '#6c5ce7',  // –ª–∞–≤–∞–Ω–¥–æ–≤—ã–π  
                        '#fd79a8',  // –ø–∞—Å—Ç–µ–ª—å–Ω–æ-—Ä–æ–∑–æ–≤—ã–π  
                        '#a29bfe',  // —Å–≤–µ—Ç–ª–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π  
                        '#55efc4'   // –∞–∫–≤–∞–º–∞—Ä–∏–Ω  
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        const categoryLabelsBar = {{ stats.by_category.keys()|list|tojson }}.map(label => {
            return label.length > 15 ? label.substring(0, 15) + '...' : label;
        });
        const lowData = {{ stats.by_category.values()|map(attribute='low')|list|tojson }};
        const mediumData = {{ stats.by_category.values()|map(attribute='medium')|list|tojson }};
        const highData = {{ stats.by_category.values()|map(attribute='high')|list|tojson }};

        const ctxBar = document.getElementById('category-bar-chart').getContext('2d');
        const categoryBarChart = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: categoryLabelsBar,
                datasets: [
                    {
                        label: '–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫',
                        data: lowData,
                        backgroundColor: '#2ecc71',
                        borderColor: '#27ae60',
                        borderWidth: 1
                    },
                    {
                        label: '–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫',
                        data: mediumData,
                        backgroundColor: '#f1c40f',
                        borderColor: '#f39c12',
                        borderWidth: 1
                    },
                    {
                        label: '–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫',
                        data: highData,
                        backgroundColor: '#e67e22',
                        borderColor: '#d35400',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: false,
                        title: {
                            display: true,
                            text: '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏'
                        },
                        ticks: {
                            maxRotation: 30, // –ü–æ–≤–æ—Ä–æ—Ç –¥–æ 90 –≥—Ä–∞–¥—É—Å–æ–≤
                            minRotation: 15, // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞
                            autoSkip: true,   // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–ø—É—Å–∫–Ω–æ—Å—Ç—å
                        }
                    },
                    y: {
                        stacked: false,
                        title: {
                            display: true,
                            text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∏—Å–∫–æ–≤'
                        },
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            // –ù–∞—Å—Ç—Ä–æ–∏–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                            title: function(tooltipItem) {
                                // –ü–æ–∫–∞–∂–µ–º –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                                const fullLabel = {{ stats.by_category.keys()|list|tojson }};
                                return fullLabel[tooltipItem[0].dataIndex]; // –ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ –∏–Ω–¥–µ–∫—Å—É
                            },
                            label: function(context) {
                                return context.dataset.label + ': ' + context.raw;
                            }
                        }
                    }
                }
            }
        });

    </script>
</body>
</html>